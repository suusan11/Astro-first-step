---
import Layout from '../../../../../layouts/Layout.astro';
import PageTitle from '../../../../../components/PageTitle.astro';
import CharacterCard from '../../../../../components/CharacterCard.astro';
import Pagination from '../../../../../components/Pagination.astro';

const metas = {
	title: "POKEMON",
	discription: "CMS(ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)ã®ãƒšãƒ¼ã‚¸ğŸ“",
	dir: '/pokemon',
    path: '../'
}

// ãƒ«ãƒ¼ãƒˆã®è¨­å®š
export async function getStaticPaths() {
    const perPage = 3; // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºæ•°
    const result = [];//è¿”å´ã™ã‚‹ã‚„ã¤

    // ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªå–å¾—
    const res = await fetch(`${import.meta.env.PUBLIC_API_URL}character_cat?per_page=100`);
    const categories = await res.json();
    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å‡¦ç†
    for( const cat of categories ){
        // ç·ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—
        const res = await fetch(`${import.meta.env.PUBLIC_API_URL}character?per_page=${perPage}&character_cat=${cat.id}`);
        const total = Number(res.headers.get('x-wp-totalpages'));
        const pages: number[] = Array(+total).fill(null).map((_, i) => i + 1);
        // 2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ãŒã‚ã‚Œã°å‡¦ç†
        if(total > 1) {
            for(let i = 2; i <= total; i++) {
                const page = i.toString();
                const res = await fetch(`${import.meta.env.PUBLIC_API_URL}character?per_page=${perPage}&character_cat=${cat.id}&page=${i}&acf_format=standard`);
                const posts = await res.json();
                result.push({ params: { category: cat.slug, page: page }, props: { posts: posts, total: total, catName: cat.name, pages: pages } });
            }
        }
    }
    return result;
}

const { category, page } = Astro.params;
const { posts, total, catName, pages } = Astro.props;

const getTermInfo = async (termId) => {
    const res = await fetch(`${import.meta.env.PUBLIC_API_URL}character_cat/${termId}`);
    const termData = await res.json();
    return termData.name || 'æœªåˆ†é¡'; // ã‚¿ãƒ¼ãƒ åãŒã‚ã‚Œã°å–å¾—ã€ãªã‘ã‚Œã° 'æœªåˆ†é¡'
};

---
<Layout title={metas.title} description={metas.discription}, dir={metas.dir}, path={metas.path}, menuBgBlue={false}>
    <section class="l-second-page l-bg-blue">
        <div class="l-container">
            <PageTitle text={`${catName}ã‚¿ã‚¤ãƒ—ã®ãƒã‚±ãƒ¢ãƒ³`} isWhite={true} />
            {posts.map((post:any) => (
                <CharacterCard href={`/pokemon/${post.slug}`} thumbnail={post.thumbnail.url} alt={post.acf.name} name={post.acf.name} cats={post.character_cat.map((catId:any) => getTermInfo(catId))}/>
            ))}
            <Pagination pages={pages} currentPage={page} parentPage={`pokemon/category/${category}`} />
        </div>
    </section>
</Layout>